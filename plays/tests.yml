---

- block:

    - name: Run helm list
      command: "/usr/local/bin/helm -n {{ dci_openshift_app_ns }} list -o json -l name=instance"
      register: helm_list

    - name: Validate helm chart is deployed
      assert:
        that: "{{ helm_list.stdout | from_json }}[0].status == 'deployed'"

    - name: Run chart-verifier
      shell: |
        podman run --rm quay.io/redhat-certification/chart-verifier verify -o json --openshift-version {{ ocp_version_full }} {{ dci_chart_tgz_url }} 2> chart-verifier-report.json
      args:
        chdir: "{{ job_logs.path }}"
      ignore_errors: true

    - name: Get chart-verifier failed tests
      shell: |
        jq '.results[]  | select(.outcome == "FAIL") | .' chart-verifier-report.json
      args:
        chdir: "{{ job_logs.path }}"
      register: chart_verifier_failures

    - name: Display chart-verifier failed tests
      debug:
        msg: "{{ chart_verifier_failures.stdout }}"

  when:
    - dci_chart_tgz_url is defined

- name: "cnf-cert tests"
  include_role:
    name: cnf-cert
    tasks_from: tests.yml
  vars:
    tnf_ns: "{{ dci_openshift_app_ns }}"
    tnf_tempdir:
      path: "{{ job_logs.path }}"
  when: do_cnf_cert|bool

- name: Preflight tests
  include_role:
    name: preflight
    tasks_from: tests.yml
  when: do_preflight_tests | bool

- name: Submit Preflight results to Pyxis
  include_role:
    name: pyxis
    tasks_from: submit.yml
  when:
    - do_preflight_tests | bool
    - submit_preflight_to_pyxis | bool

...
